<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="author" content="lei"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>springboot集成log4jdbc-log4j2打印SQL</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/carbon.css"><script defer="defer" src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/jquery.pjax/1.9.5/jquery.pjax.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.css" type="text/css" media="screen"><script defer="defer" type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>var performFancybox = true;</script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/katex/0.5.0/katex.min.css"><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/katex.min.js"></script><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/contrib/auto-render.min.js"></script><script>var doRenderMath = 'katex';</script><script defer="defer" src="/js/carbon.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container"><div id="banner"><h1 id="site-title"><a href="/">雷德王的🏠</a></h1><p id="site-subtitle">code code code 💰 💰 💰</p></div><div id="content"><div class="meta"><h2 class="article-title"><a href="/2021/05/07/2021507-springboot%E9%9B%86%E6%88%90log4jdbc-log4j2%E6%89%93%E5%8D%B0SQL">springboot集成log4jdbc-log4j2打印SQL</a></h2><div class="article-date"><a href="javascript:void(0);" class="extra-switch">2021-05-07</a></div></div><div class="extra"><span class="Tags">Tags: <a href="/tags/springboot/">springboot</a>, <a href="/tags/java/">java</a>.</span></div><div class="extra"><span class="Categories">Categories: <a href="/categories/java/">java</a>.</span></div><div class="article-content"><div class="gallery"></div><p>一般项目中打印出来的sql都是一堆恶心的占位符或者是像jpa那种各种别名的sql导致定位sql的时候特别的麻烦所以引入<strong>log4jdbc-log4j2</strong>来解决这个问题</p>
<p>官方配置地址：<a target="_blank" rel="noopener" href="http://log4jdbc.brunorozendo.com/">http://log4jdbc.brunorozendo.com/</a></p>
<p>想快速接入的话直接用springboot的启动器:<a target="_blank" rel="noopener" href="https://github.com/candrews/log4jdbc-spring-boot-starter">https://github.com/candrews/log4jdbc-spring-boot-starter</a></p>
<p>1.springboot已经集成了slf4j所以无需过多的导入pom只需要导入如下pom即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.bgee.log4jdbc-log4j2<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4jdbc-log4j2-jdbc4.1<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.修改yml里面的jdbc驱动</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment">#driver-class-name: com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">net.sf.log4jdbc.sql.jdbcapi.DriverSpy</span></span><br><span class="line">    <span class="comment">#url: jdbc:mysql://localhost:3306/test?useUnicode=true&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:log4jdbc:mysql://localhost:3306/test?useUnicode=true&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</span></span><br></pre></td></tr></table></figure>

<p>3.启动项目打印发现sql已经打出来了,但是打出了一堆无关紧要的东西我们只需要关心的是sql和返回出来的结果,官方说如果选择使用SLF4J而不是Log4j2，则需要将选项log4jdbc.spylogdelegator.name配置为值net.sf.log4jdbc.log.slf4j.Slf4jSpyLogDelegator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.115</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.getType() returned <span class="number">1003</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.getType() returned <span class="number">1003</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.isClosed() returned <span class="keyword">false</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.isClosed() returned <span class="keyword">false</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.next() returned <span class="keyword">true</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.next() returned <span class="keyword">true</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.getLong(id) returned <span class="number">2</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.getLong(id) returned <span class="number">2</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.getString(username) returned demo</span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.getString(username) returned demo</span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.getString(password) returned <span class="number">11231</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.116</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.getString(password) returned <span class="number">11231</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.117</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">1.</span> ResultSet.isClosed() returned <span class="keyword">false</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.117</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - <span class="number">14.</span> ResultSet.isClosed() returned <span class="keyword">false</span></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">13.117</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">5</span>] [demo] [] [] INFO  log4jdbc.log4j2 - </span><br><span class="line">|---|---------|---------|</span><br><span class="line">|id |username |password |</span><br><span class="line">|---|---------|---------|</span><br><span class="line">|<span class="number">2</span>  |demo     |<span class="number">11231</span>    |</span><br><span class="line">|---|---------|---------|</span><br></pre></td></tr></table></figure>

<p>4.配置Slf4jSpyLogDelegator来解决问题,还有一些其他的配置可以看启动器的那个项目这里不就写了, Log4jdbc仅从系统属性读取配置，因此将相关的环境属性复制到系统属性,包括yml或者properties里面的一些配置才能被读取到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;log4jdbc.spylogdelegator.name&quot;</span>, <span class="keyword">this</span>.environment.getProperty(<span class="string">&quot;log4jdbc.spylogdelegator.name&quot;</span>, Slf4jSpyLogDelegator.class.getName()));</span><br></pre></td></tr></table></figure>



<p>5.yml配置log的过滤规则必须完成第四部才能生效</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">jdbc:</span></span><br><span class="line">      <span class="attr">sqltiming:</span> <span class="string">warn</span></span><br><span class="line">      <span class="attr">audit:</span> <span class="string">OFF</span></span><br><span class="line">      <span class="attr">resultset:</span> <span class="string">OFF</span></span><br><span class="line">      <span class="attr">connection:</span> <span class="string">OFF</span></span><br></pre></td></tr></table></figure>



<p>6.测试并且打印出正常的sql</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">15</span>:<span class="number">07</span>:<span class="number">21.617</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">1</span>] [demo] [] [] INFO  jdbc.sqlonly - SELECT id,username,password FROM user WHERE id=<span class="number">2</span> </span><br><span class="line"></span><br><span class="line">[<span class="number">2021</span>-<span class="number">05</span>-<span class="number">07</span> <span class="number">15</span>:<span class="number">07</span>:<span class="number">21.633</span>] [http-nio-<span class="number">123</span>-exec-<span class="number">1</span>] [demo] [] [] INFO  jdbc.resultsettable - </span><br><span class="line">|---|---------|---------|</span><br><span class="line">|id |username |password |</span><br><span class="line">|---|---------|---------|</span><br><span class="line">|<span class="number">2</span>  |demo     |<span class="number">11231</span>    |</span><br><span class="line">|---|---------|---------|</span><br></pre></td></tr></table></figure>

</div><nav class="pagination"><a id="left-navigator" href="/2021/05/15/2021510-javaScript-ast%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AE%9E%E6%88%98/">javaScript ast反混淆实战</a><a id="right-navigator" href="/2021/04/12/2021412-monitor%E8%AE%BE%E8%AE%A1/">monitor设计</a></nav></div><nav id="footer"><ul id="footer-links"><li><a href="/about">About</a></li><li><a href="/archives">Archives</a></li><li><a href="/atom.xml">RSS</a></li><li><a target="_blank" rel="noopener" href="https://icylogic.net" class="out-site">Theme.Carbon</a></li><li><a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo" class="out-site">Hexo</a></li></ul></nav></div></body></html>