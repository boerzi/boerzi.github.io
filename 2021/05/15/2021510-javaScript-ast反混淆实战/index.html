<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta name="author" content="lei"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>javaScript ast反混淆实战</title><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/normalize/3.0.3/normalize.min.css"><link rel="stylesheet" type="text/css" href="/css/carbon.css"><script defer="defer" src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/jquery.pjax/1.9.5/jquery.pjax.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.css" type="text/css" media="screen"><script defer="defer" type="text/javascript" src="//cdn.jsdelivr.net/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>var performFancybox = true;</script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/katex/0.5.0/katex.min.css"><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/katex.min.js"></script><script async="async" type="text/javascript" src="//cdn.jsdelivr.net/katex/0.5.0/contrib/auto-render.min.js"></script><script>var doRenderMath = 'katex';</script><script defer="defer" src="/js/carbon.js"></script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="container"><div id="banner"><h1 id="site-title"><a href="/">雷德王的🏠</a></h1><p id="site-subtitle">code code code 💰 💰 💰</p></div><div id="content"><div class="meta"><h2 class="article-title"><a href="/2021/05/15/2021510-javaScript-ast%E5%8F%8D%E6%B7%B7%E6%B7%86%E5%AE%9E%E6%88%98">javaScript ast反混淆实战</a></h2><div class="article-date"><a href="javascript:void(0);" class="extra-switch">2021-05-15</a></div></div><div class="extra"><span class="Tags">Tags: <a href="/tags/%E9%80%86%E5%90%91/">逆向</a>.</span></div><div class="extra"><span class="Categories">Categories: <a href="/categories/javaScript/">javaScript</a>.</span></div><div class="article-content"><div class="gallery"></div><p><img src="https://img-blog.csdnimg.cn/img_convert/065d01891f54eb2e8b3f7d2f6bad34d5.png#alt=" alt="img"></p>
<p><img src="https://img2020.cnblogs.com/blog/1249183/202012/1249183-20201231140127195-1112341309.png" alt="img"></p>
<p>在线解析ast:<a target="_blank" rel="noopener" href="https://astexplorer.net/">https://astexplorer.net/</a></p>
<p>ast对线文档:<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#node_objects">https://developer.mozilla.org/en-US/docs/Mozilla/Projects/SpiderMonkey/Parser_API#node_objects</a></p>
<h2 id="1-babel-parser"><a href="#1-babel-parser" class="headerlink" title="1.@babel/parser"></a>1.@babel/parser</h2><p>​    Babel解析器用来解析JavaScript <a target="_blank" rel="noopener" href="https://github.com/babel/babel/tree/main/packages/babel-parser/ast/spec.md">Babel AST格式</a>生成AST</p>
<h2 id="2-babel-traverse"><a href="#2-babel-traverse" class="headerlink" title="2.@babel/traverse"></a>2.@babel/traverse</h2><p>​    用来遍历更新parser生成ast</p>
<h2 id="3-babel-generator"><a href="#3-babel-generator" class="headerlink" title="3.@babel/generator"></a>3.@babel/generator</h2><p>​    生成代码</p>
<h2 id="4-babel-types"><a href="#4-babel-types" class="headerlink" title="4.@babel/types"></a>4.@babel/types</h2><p>​    创建AST的过程中判断各种语法的类型</p>
<h2 id="5-实战"><a href="#5-实战" class="headerlink" title="5.实战"></a>5.实战</h2><p>使用ast替换snkrs kp加密function函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">KPSDK_0xd388</span>(<span class="params">_0x36e203, _0x31a60a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> KPSDK_0x3eca = <span class="string">&#x27;自己去js里面复制&#x27;</span>];</span><br><span class="line">    (<span class="function"><span class="keyword">function</span> (<span class="params">_0x44ed45, _0x413224</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _0x2699a9 = <span class="function"><span class="keyword">function</span> (<span class="params">_0x501e82</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (--_0x501e82) &#123;</span><br><span class="line">                _0x44ed45[<span class="string">&#x27;push&#x27;</span>](_0x44ed45[<span class="string">&#x27;shift&#x27;</span>]());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        _0x2699a9(++_0x413224);</span><br><span class="line">    &#125;(KPSDK_0x3eca, <span class="number">0x13d</span>));</span><br><span class="line">    _0x36e203 = _0x36e203 - <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">var</span> _0x135839 = KPSDK_0x3eca[_0x36e203];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (KPSDK_0xd388[<span class="string">&#x27;yyKxZG&#x27;</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x26998c;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> _0x326096 = <span class="built_in">Function</span>(<span class="string">&#x27;return\x20(function()\x20&#x27;</span> + <span class="string">&#x27;&#123;&#125;.constructor(\x22return\x20this\x22)(\x20)&#x27;</span> + <span class="string">&#x27;);&#x27;</span>);</span><br><span class="line">                _0x26998c = _0x326096();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (_0x4f24c3) &#123;</span><br><span class="line">                _0x26998c = <span class="built_in">window</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> _0x5a28f7 = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=&#x27;</span>;</span><br><span class="line">            _0x26998c[<span class="string">&#x27;atob&#x27;</span>] || (_0x26998c[<span class="string">&#x27;atob&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x53a838</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">var</span> _0x779905 = <span class="built_in">String</span>(_0x53a838)[<span class="string">&#x27;replace&#x27;</span>](<span class="regexp">/=+$/</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> _0x1ed495 = <span class="number">0x0</span>, _0x24479b, _0x1c3d11, _0x420bc2 = <span class="number">0x0</span>, _0x199342 = <span class="string">&#x27;&#x27;</span>; _0x1c3d11 = _0x779905[<span class="string">&#x27;charAt&#x27;</span>](_0x420bc2++); ~_0x1c3d11 &amp;&amp; (_0x24479b = _0x1ed495 % <span class="number">0x4</span> ? _0x24479b * <span class="number">0x40</span> + _0x1c3d11 : _0x1c3d11, _0x1ed495++ % <span class="number">0x4</span>) ? _0x199342 += <span class="built_in">String</span>[<span class="string">&#x27;fromCharCode&#x27;</span>](<span class="number">0xff</span> &amp; _0x24479b &gt;&gt; (-<span class="number">0x2</span> * _0x1ed495 &amp; <span class="number">0x6</span>)) : <span class="number">0x0</span>) &#123;</span><br><span class="line">                    _0x1c3d11 = _0x5a28f7[<span class="string">&#x27;indexOf&#x27;</span>](_0x1c3d11);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> _0x199342;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;());</span><br><span class="line">        KPSDK_0xd388[<span class="string">&#x27;JgnmlJ&#x27;</span>] = <span class="function"><span class="keyword">function</span> (<span class="params">_0x1023bd, _0x31a60a</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _0x493ad7 = [], _0x3b3bca = <span class="number">0x0</span>, _0x2e61dd, _0x478acf = <span class="string">&#x27;&#x27;</span>, _0x38dbec = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            _0x1023bd = atob(_0x1023bd);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x58eb8e = <span class="number">0x0</span>, _0x2638de = _0x1023bd[<span class="string">&#x27;length&#x27;</span>]; _0x58eb8e &lt; _0x2638de; _0x58eb8e++) &#123;</span><br><span class="line">                _0x38dbec += <span class="string">&#x27;%&#x27;</span> + (<span class="string">&#x27;00&#x27;</span> + _0x1023bd[<span class="string">&#x27;charCodeAt&#x27;</span>](_0x58eb8e)[<span class="string">&#x27;toString&#x27;</span>](<span class="number">0x10</span>))[<span class="string">&#x27;slice&#x27;</span>](-<span class="number">0x2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            _0x1023bd = <span class="built_in">decodeURIComponent</span>(_0x38dbec);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x307461 = <span class="number">0x0</span>; _0x307461 &lt; <span class="number">0x100</span>; _0x307461++) &#123;</span><br><span class="line">                _0x493ad7[_0x307461] = _0x307461;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (_0x307461 = <span class="number">0x0</span>; _0x307461 &lt; <span class="number">0x100</span>; _0x307461++) &#123;</span><br><span class="line">                _0x3b3bca = (_0x3b3bca + _0x493ad7[_0x307461] + _0x31a60a[<span class="string">&#x27;charCodeAt&#x27;</span>](_0x307461 % _0x31a60a[<span class="string">&#x27;length&#x27;</span>])) % <span class="number">0x100</span>;</span><br><span class="line">                _0x2e61dd = _0x493ad7[_0x307461];</span><br><span class="line">                _0x493ad7[_0x307461] = _0x493ad7[_0x3b3bca];</span><br><span class="line">                _0x493ad7[_0x3b3bca] = _0x2e61dd;</span><br><span class="line">            &#125;</span><br><span class="line">            _0x307461 = <span class="number">0x0</span>;</span><br><span class="line">            _0x3b3bca = <span class="number">0x0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> _0x445a25 = <span class="number">0x0</span>; _0x445a25 &lt; _0x1023bd[<span class="string">&#x27;length&#x27;</span>]; _0x445a25++) &#123;</span><br><span class="line">                _0x307461 = (_0x307461 + <span class="number">0x1</span>) % <span class="number">0x100</span>;</span><br><span class="line">                _0x3b3bca = (_0x3b3bca + _0x493ad7[_0x307461]) % <span class="number">0x100</span>;</span><br><span class="line">                _0x2e61dd = _0x493ad7[_0x307461];</span><br><span class="line">                _0x493ad7[_0x307461] = _0x493ad7[_0x3b3bca];</span><br><span class="line">                _0x493ad7[_0x3b3bca] = _0x2e61dd;</span><br><span class="line">                _0x478acf += <span class="built_in">String</span>[<span class="string">&#x27;fromCharCode&#x27;</span>](_0x1023bd[<span class="string">&#x27;charCodeAt&#x27;</span>](_0x445a25) ^ _0x493ad7[(_0x493ad7[_0x307461] + _0x493ad7[_0x3b3bca]) % <span class="number">0x100</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> _0x478acf;</span><br><span class="line">        &#125;;</span><br><span class="line">        KPSDK_0xd388[<span class="string">&#x27;TfkyIj&#x27;</span>] = &#123;&#125;;</span><br><span class="line">        KPSDK_0xd388[<span class="string">&#x27;yyKxZG&#x27;</span>] = !![];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> _0xe278d8 = KPSDK_0xd388[<span class="string">&#x27;TfkyIj&#x27;</span>][_0x36e203];</span><br><span class="line">    <span class="keyword">if</span> (_0xe278d8 === <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (KPSDK_0xd388[<span class="string">&#x27;pigCLi&#x27;</span>] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            KPSDK_0xd388[<span class="string">&#x27;pigCLi&#x27;</span>] = !![];</span><br><span class="line">        &#125;</span><br><span class="line">        _0x135839 = KPSDK_0xd388[<span class="string">&#x27;JgnmlJ&#x27;</span>](_0x135839, _0x31a60a);</span><br><span class="line">        KPSDK_0xd388[<span class="string">&#x27;TfkyIj&#x27;</span>][_0x36e203] = _0x135839;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _0x135839 = _0xe278d8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _0x135839;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">exports</span>.fuck = KPSDK_0xd388</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行这样就可以gen出反混淆以后的code</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>)</span><br><span class="line"><span class="comment">//babel解析ast</span></span><br><span class="line"><span class="keyword">const</span> babelParser = <span class="built_in">require</span>(<span class="string">&quot;@babel/parser&quot;</span>);</span><br><span class="line"><span class="comment">//生成ast</span></span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">&#x27;@babel/traverse&#x27;</span>).default</span><br><span class="line"><span class="comment">//生成代码</span></span><br><span class="line"><span class="keyword">const</span> generator = <span class="built_in">require</span>(<span class="string">&quot;@babel/generator&quot;</span>).default;</span><br><span class="line"><span class="comment">//类型</span></span><br><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">&quot;@babel/types&quot;</span>);</span><br><span class="line"><span class="comment">//fuck函数</span></span><br><span class="line"><span class="keyword">const</span> f = <span class="built_in">require</span>(<span class="string">&quot;./fuck.js&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> code = fs.readFileSync(<span class="string">&quot;./kpskd.js&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> ast = babelParser.parse(code);</span><br><span class="line"></span><br><span class="line"><span class="comment">//生成ast</span></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">    <span class="function"><span class="title">CallExpression</span>(<span class="params">p</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.node.callee.name === <span class="string">&quot;KPSDK_0xd388&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> name = f.fuck(p.node.arguments[<span class="number">0</span>].value, p.node.arguments[<span class="number">1</span>].value)</span><br><span class="line">            p.replaceWith(t.stringLiteral(name))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//gen code</span></span><br><span class="line"><span class="keyword">let</span> outPut = generator(ast)[<span class="string">&quot;code&quot;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(outPut)</span><br><span class="line">fs.writeFileSync(<span class="string">&quot;ips2.js&quot;</span>,outPut)</span><br></pre></td></tr></table></figure></div><nav class="pagination"><a id="right-navigator" href="/2021/05/07/2021507-springboot%E9%9B%86%E6%88%90log4jdbc-log4j2%E6%89%93%E5%8D%B0SQL/">springboot集成log4jdbc-log4j2打印SQL</a></nav></div><nav id="footer"><ul id="footer-links"><li><a href="/about">About</a></li><li><a href="/archives">Archives</a></li><li><a href="/atom.xml">RSS</a></li><li><a target="_blank" rel="noopener" href="https://icylogic.net" class="out-site">Theme.Carbon</a></li><li><a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo" class="out-site">Hexo</a></li></ul></nav></div></body></html>